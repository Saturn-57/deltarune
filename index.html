<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>DELTARUNE</title>
  <link rel="stylesheet" href="../css/canvas.css">

</head>
<body>

  <div id="root">
    <audio id="bgm" src="music.mp3" loop></audio>
  

    <div id="gamewindow">
      <canvas id="game" width="2048" height="1024"></canvas>
    </div>

    <div id="UI">
      <section id="tip"> <!--tip section on the JS thignaling-->
        <h2>Use WASD or Arrow Keys to Move</h2>
      </section>

      <p>thing</p>

      <section id="">
        <p>something something</p>
      </section>
    </div>

  </div>

<script>
/* =======================
 VARIABLES & AUDIO
======================= */

const worldWidth  = map[0].length * TILE_SIZE;
const worldHeight = map.length * TILE_SIZE;


import { Camera } from "./camera.js";
import { TileMap } from "./tiles.js";
import { maps } from "./maps.js";

const tileMap = new TileMap(maps.room1);

const camera = new Camera(
  canvas.width,
  canvas.height,
  tileMap.width * TILE_SIZE,
  tileMap.height * TILE_SIZE
);



const bgm = document.getElementById("bgm");
const tipSection = document.getElementById("tip");

window.addEventListener("keydown", () => {
  bgm.volume = 0.2;
  bgm.play();

  tipSection.remove();

}, { once: true });

const audioCtx = new AudioContext();
const audio = new Audio("music.mp3");
const track = audioCtx.createMediaElementSource(audio);
track.connect(audioCtx.destination);
audio.loop = true;

window.addEventListener("keydown", () => {
  audioCtx.resume();
  audio.play();
}, { once: true });



/* =======================
   SETUP
======================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

ctx.imageSmoothingEnabled = false;
ctx.webkitImageSmoothingEnabled = false;
ctx.mozImageSmoothingEnabled = false;

const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

/* =======================
   KRIS
======================= */
const sprite = new Image();
sprite.src = "player.png";

const FRAME_W = 19;
const FRAME_H = 37;
const FRAMES_PER_DIR = 4;
const SCALE = 3;

/* ======================
   KRIS MOVEMENT
======================= */
const player = {
  x: 1000,
  y: 500,
  speed: 220,
  dir: "down",
  frame: 0,
  frameTimer: 0,
  moving: false,
};

const DIR_ROW = {
  down: 0,
  left: 1,
  right: 2,
  up: 3,
};

/* =======================
   GAME LOOP
======================= */
let lastTime = 0;

function loop(time) {
  const dt = (time - lastTime) / 1000;
  lastTime = time;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);

/* =======================
   UPDATE
======================= */
function update(dt) {
  let dx = 0;
  let dy = 0;
  player.moving = false;

  if (keys["w"] || keys["ArrowUp"]) {
    dy -= 1;
    player.dir = "up";
  }
  if (keys["s"] || keys["ArrowDown"]) {
    dy += 1;
    player.dir = "down";
  }
  if (keys["a"] || keys["ArrowLeft"]) {
    dx -= 1;
    player.dir = "left";
  }
  if (keys["d"] || keys["ArrowRight"]) {
    dx += 1;
    player.dir = "right";
  }

  if (dx !== 0 || dy !== 0) {
    // normalize diagonal movement
    const len = Math.hypot(dx, dy);
    dx /= len;
    dy /= len;

    player.x += dx * player.speed * dt;
    player.y += dy * player.speed * dt;
    player.moving = true;
  }

  // Animate only while moving
  if (player.moving) {
    player.frameTimer += dt;
    if (player.frameTimer > 0.15) {
      player.frame = (player.frame + 1) % FRAMES_PER_DIR;
      player.frameTimer = 0;
    }
  } else {
    player.frame = 0; // idle frame
  }
}

/* =======================
   DRAW
======================= */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const row = DIR_ROW[player.dir];

  const drawX = Math.floor(player.x);
  const drawY = Math.floor(player.y - FRAME_H * SCALE); //based off from the feet

  ctx.drawImage(
    sprite,
    player.frame * FRAME_W,
    row * FRAME_H,
    FRAME_W,
    FRAME_H,
    drawX,
    drawY,
    FRAME_W * SCALE,
    FRAME_H * SCALE
  );
}
</script>

</body>
</html>



